## 简介<a id="简介"></a>
![image](./assets/安装界面.png)

`SpatialBox For AutoCAD` 是一款基于 AutoCAD 的 GIS 扩展插件，围绕数据格式转换、属性管理、空间拓扑、栅格扩展等方面，系统性增强 AutoCAD 的地理数据处理能力。

### 功能模块<a id="功能模块"></a>

- 导入导出：支持 `SHP`，`GDB`，`KML`，`JSON`，`Excel` 等数据的加载和导出，支持弧，多部件和属性；
- 属性管理：具备完整的字段和属性管理功能，可执行多功能的字段计算器，属性选择，属性连接等；
- 空间拓扑：支持拓扑验证，拓扑检查，并可进行空间连接，空间选择等；
- 栅格工具：支持批量加载光栅图像，加载超大影像，影像合并拆分转换，在线地图浏览，下载，并支持自定义图源；
- 编辑工具：提供常规的一些点，线，面编辑功能；
- 标注注记：提供字段标注，字段注记，长度标注等功能，并可进行动态标注；
- 通用工具：系列工具的集合，诸如批量打印，文件合并拆分等；

### 运行环境<a id="运行环境"></a>

| <span style="font-weight:normal">操作系统</span> | <span style="font-weight:normal">Windows7 - Windows11</span> |
| :----------------------------------------------: | :----------------------------------------------------------: |
|                     AutoCAD                      |                AutoCAD 2013-2024 （32-64位）                 |
|                     运行框架                     |                      NET Framework 4.0                       |

### 安装和卸载<a id="安装和卸载"></a>

软件提供绿色自解压安装包，默认安装目录为 `D:\SpatialBox`，若要卸载删除该目录即可。

![image](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230708171534298.png)

> 安装目录下的 `user` 文件夹可能有您自己保存的数据，删除时请注意检查备份。

### 启用和停用<a id="启用和停用"></a>

安装后显示 `SpatialBox启动器` 界面，![image-20230708173023693](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230708173023693.png)可启用、停用插件，![image-20230708173240043](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230708173240043.png)可快速打开相应版本的 CAD。

![image-20230708173129275](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230708173129275.png)

> - 当启动器左下角出现版本更新提示时，点击可查看和下载新版本。
>
> - 某些精简版 CAD 可能移除了一些关键模块，导致插件无法正常运行，请注意安装完整版 CAD。

### 技术支持<a id="技术支持"></a>

![image-20230709113354597](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709113354597.png)

- [更新日志](https://gitee.com/sureleo/spatialbox/raw/master/UpdateLog)
- [下载链接](http://spatialbox.ysepan.com/)



## 导入导出<a id="导入导出"></a>

导入导出是与外部数据交互的主要方式，目前支持的矢量格式如下：<a id="支持的矢量格式"></a>

| 名称                                   | 后缀                    | 读                                             | 写                                             | 说明           |
| -------------------------------------- | ----------------------- | ---------------------------------------------- | ---------------------------------------------- | -------------- |
| ESRI Shapefile                         | `shp` `shx` `dbf` `cpg` | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |
| ESRI File Geodatabase (FileGDB)        | `gdb`                   | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |
| Keyhole Markup Language                | `kml` `kmz`             | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |
| Excel                                  | `xlsx` `xls`            | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | 导出格式为xlsx |
| GeoJSON                                | `json` `geojson`        | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |
| Personal GeoDatabase（个人地理数据库） | `mdb`                   | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                                                |                |
| Comma Separated Value（逗号分隔文件）  | `csv`                   | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |
| GeoPackage（矢量）                     | `gpkg`                  | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) | ![](C:\LeoCode\HtCadTool\HelpMd\assets/ok.png) |                |

### 导入数据<a id="导入数据"></a>

可将外部数据导入到 `AutoCAD` 中，支持的格式有 `Shapefile`，`FileGDB`，`Kml`，`Xlsx`，`GeoJson `等，加载方法如下：

- **方法1**：单击 `目录` ，找到需要加载的数据，双击或者右键即可加载；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/内容列表-目录.png)

- **方法2**：`图层根节点右键 > 添加数据`，浏览并选择需要加载的数据即可；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/添加数据.png)

  > 表格也可以通过这个方式加载，在表格根节点右键即可。

- **方法3**：对于 `Shapefile`，`GeoJson` 等单图层文件，可以将 `shp` `json` 直接拖动到图层面板实现加载；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/添加数据1.png)

**注意事项**

- 导入数据是把外部数据转换为 CAD 的图元，所以在 CAD 中编辑并不会修改外部数据；

- 转换过程中，字段名中不支持的字符会被替换为下划线；

- 导出为 `kmz` 时，若图层中包含中文图层名，可能导致无法读取该图层，可用解压软件打开 `kmz` 文件，将其中的 `kml` 解压后再加载；

- 多部件多边形导入时有两种方案：

  - 导入为多段线：此方案会将多个部件转换为由多段线（`Polyline`）构成的块。
  - 导入为填充：多边形会被转为填充（`Hatch`）,该方案效率较低。

- `KML` 和 `GeoJson` 格式本身不限制要素类型，为规范操作，本软件取图层中的第一个要素类型作为图层要素类型，以便转换；

- 可通过命令 `GCC` 进行要素导入设置。

  ![image-20230710163542468](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230710163542468.png)

### 导出数据<a id="导出数据"></a>

可将 `AutoCAD` 中的数据导出为其他格式，支持的格式有 `Shapefile`，`FileGDB`，`Kml`，`Xlsx`，`GeoJson` 等，导出方法如下：

- **方法1**：`图层根节点右键 > 导出 > 选择目标格式`，再勾选要导出的图层和要素类型即可，此方法一次可导出多个 `CAD` 图层；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/导出数据1.png)

- **方法2**：`图层节点右键 > 导出 > 选择目标格式`，再勾选要导出的要素类型即可，此方法一次导出一个 `CAD` 图层；

  ![image-20230709111538513](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709111538513.png)

### 格式相关说明<a id="格式相关说明"></a>

**SHP**

- 关于 `SHP` 的字段长度

  > - `SHP` 的属性数据存储在 `DBF` 文件中，这种文件比较古早，字段名长度最多只能有10个字节，字节≠字数，这涉及编码问题，国内常用的编码有两种：`UTF-8` 和 `GBK`：
  >  - UTF-8：一个英文字母占1字节，一个汉字占3字节，这意味着该编码下的字段名最多3个汉字。
  >   - GBK（CP936）：英文字母占1字节，汉字占2字节，这就可以让字段名支持最多5个汉字，在实用性上有一定优势。
  > - 综上，**建议采取 `GBK` 编码**导出 `SHP` 文件。

- `SHP` 的文本字段长度最大为 256；

**KML**

- 关于 `KML` 坐标系

  > - `KML` 将坐标存储为基于 `WGS84 （EPSG: 4326）` 数据的经纬度值。这是 `KML` 唯一支持的坐标系。所以您必须指定当前数据的坐标系，以确保软件能将坐标正确转换为 `WGS84`。
  > - 设置投影的方法参见  [`空间参考`](#空间参考) ；同时也可以在输出界面选择 `坐标系` 来设置。

**GDB**

- 关于 `GDB` 字段和图层名

  > - 字段名称限制为 64 个字符；
  > - 图层名必须以字母或下划线开头，所有不满足该规则的图层名会被调整，具体规则如下：
  >   - 名称必须以汉字或字母开头；
  >   - 名称不应包含空格；
  >   - 最多包含 64 个字符；

- `GDB` 支持常规弧段，椭圆和贝塞尔曲线则转为近似点。

**CSV**

- `CSV` 作为纯文本文件，通常用于较简单的属性交换；

- 若要在输出 `CSV` 文件时保存图形信息，可勾选输出 `WKT` 字段，该字段会保存图元的几何信息，这种带几何信息的 `CSV` 文件被称为 `GeoCSV`。
- 当输出为 `GeoCSV` 时，会创建同名且后缀为 `csvt` 的字段描述文件，若删除该文件，则所有字段会被按照字符串读取；
- 当输出为 `GeoCSV` 时，若指定了 [`空间参考`](#空间参考)，会创建同名且后缀为 `prj` 投影文件，这点和 `shp` 相同。
- `CSV` 可以用文本编辑器直接打开并修改，这点类似于 `KML` 和 `GeoJSON`。

### 土地报备<a id="土地报备"></a>

- 导入土地报备数据，命令 `BBDR`

  ![image-20230709154747170](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709154747170.png)

  > - 导入时可选择多个 `txt` 同时导入，默认导入到文件同名图层。
  >
  > - 属性导入到对应字段中，可自由修改。

  ![image-20230709155133997](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709155133997.png)

- 导出土地报备数据，命令 `BBDC`

  ![image-20230709154108127](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709154108127.png)



## 属性管理<a id="属性管理"></a>

### 字段<a id="字段"></a>

`AutoCAD` 作为计算机辅助设计软件，并未提供严格意义上的字段支持，用户可通过扩展属性 (`XDATA`)  或扩展字典 (`DBDictionary`) 保存自定义数据；

综合考虑运行效率、通用性及兼容性，本软件选择  (`XDATA`)  ，通过定制实现属性管理功能，支持的数据类型如下：

| 字段类型        | 存储类型 | 说明                                                         |
| --------------- | -------- | ------------------------------------------------------------ |
| `OFTString`     | 文本     | 常用的字符串字段                                             |
| `OFTInteger`    | 整数     | 整数型字段                                                   |
| `OFTReal`       | 小数     | 小数型字段，如果字段值是 54.234，则小数位数 = 3，精度 = 5。  |
| `OFTStringList` | 多种     | 多值字段，该类型可在一个字段中保存多个内容。<br />注：该类型仅为兼容一些旧版数据存在，如无必要，不建议使用 |
| `DateTime`      | 文本     | 日期字段，实际存储字符串，仅在数据转换时用于规范字段         |

> 您可以通过 `字段管理器` 来添加，删除，修改字段；

受限于 `AutoCAD` 数据结构，使用扩展字段保存数据有一些限制，具体如下：

- 单个要素字符总数不能超过8188，超过会提示 eXdataSizeExceeded 错误 （按AutoCAD2012测试结果，不同版本可能略有出入）；

- 为保持和低版本数据的兼容性，要素单个字段长度最好不要超过255，否则 AUDIT 命令可能会造成数据丢失，若要使用内容长度超过255的字符串，则不要轻易使用 AUDIT 命令，切记；

  > `AUDIT` 命令，选择 `N`，若提示类似： XData String Length 265 > 255      Truncate to 255，表示该要素字段长度超过255

- 若每个字符串字段长度为255，则单个要素最多可保存32个字段 （8188/255），在处理大量属性时请注意；

- 字段名只能以字母或汉字开头，且只能由汉字，字母，数字，下划线构成，建议字段长度不要超过50个字符；

### 字段管理器<a id="字段管理器"></a>

字段管理器是管理字段的主要方式，可以对字段进行添加、删除、修改等操作，并可加载和保存字段模板。

- 命令 `SFM` ，可打开当前图层的字段管理器。
- `内容列表 > 选中图层 > 右键 > 字段`，可打开该图层的字段管理器。

![image-20230709120543047](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709120543047.png)

- 添加字段：在字段管理器界面点击添加字段，设置字段名，类型，长度等参数，点击确定即可添加字段；

![image-20230709121323694](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709121323694.png)

- 删除字段：在字段列表中选中要删除的字段 ，可选择多个，再点击删除字段，提示选择是即可删除所选字段；

  > 删除字段后若不勾选应用到所有要素选项，则要素中**数据实际并未被修改**，只是限制了对该字段值的编辑，此类数据在属性值窗口显示为灰色不可编辑状态，定义同名字段后即可恢复编辑

- 修改字段：双击字段，弹出编辑窗口，按需求修改后，点击确定即可修改

  > 修改字段会影响该图层的所有要素，对字段类型的修改可能造成部分数据丢失，对字段长度的修改可能造成字段值被裁减，请谨慎操作。

- 加载&保存模板：当前字段可通过保存模板来保存到本地，在其他有相同字段需求的场合，通过加载模板来批量设置这些字段，也可以自行编辑好后直接加载。

  > 字段模板格式为CSV文件，可通过Excel或文本编辑器直接编辑（名称，类型，长度为必填项），参考如下

  ![image-20230709122125381](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709122125381.png)

### 属性表<a id="属性表"></a>

属性表是管理属性数据的主要方式，通过属性表可对属性进行编辑、查找、选择、图形定位、字段计算、属性选择等操作。

![](C:\LeoCode\HtCadTool\HelpMd\assets/属性表.png)

您可通过以下方式打开属性表：

- `内容列表 > 双击图层名` ，可快速打开对应属性表；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/图层菜单-打开属性表-双击.png)

- `内容列表 > 图层右键 > 打开属性表`，可打开所选图层的属性表；

  ![](C:\LeoCode\HtCadTool\HelpMd\assets/图层菜单-打开属性表.png)

- 命令 `STABLE` ，可打开当前图层对应的属性表；

#### 按属性选择<a id="按属性选择"></a>

按属性选择主要用于快速筛选定位并记录，单击属性表上方的按属性选择，可激活该功能

![image-20230709135808587](C:\LeoCode\HtCadTool\HelpMd\assets/按属性选择.png)

**使用提示**

> - 双击字段，可在表达式中插入该字段；
> - 选择字段后单击获取唯一值，可列出该字段的所有唯一值；
> - 双击唯一值，可在表达式窗口插入该值；
> - 单击操作符按钮可插入对应操作符；
> - 具体使用可参考关于属性选择的链接；

#### 字段计算器<a id="字段计算器"></a>

字段计算器主要用于批量修改字段内容的，打开属性表后，`字段标题右键 > 字段计算器` 即可打开字段计算器。

![image-20230709141033433](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709141033433.png)

- 函数类型包括：工具、字符串、数字、转换，用于切换功能区的常用函数，实际可用函数远不止这些，具体可参考 [`计算字段示例`](#计算字段示例)。

  > 函数类型中的 `工具` 是软件定制的一些函数，该列表会按需求更新。

- 字段和功能：双击字段名，可在表达式中插入该字段，双击功能函数，可在表达式中插入该函数；

- 表达式：输入表达式后，下方预览区域会实时显示计算结果，若表达式有误，则会提示错误，可按提示修改；

  > - 表达式可通过保存功能存储到本地，并通过加载调用；
  > - 输入表达式时，下方的提示框会动态显示计算结果，该结果基于属性表第一行数据（若有选中的行，则基于所选的第一行）

- 表达式使用 C# 代码，支持大量常用语法，支持 LINQ ，可通过编写代码实现自定义功能。

#### 计算字段示例<a id="计算字段示例"></a>

**字符串**

- 字符串要用西文的单引号(')或者双引号(")括起来

  > 例：'我是字符串1'，"我是字符串2" 

- 字符串合并，用加号(+)连接即可

  > 例：'我是'+'字符串1'，计算结果为 '我是字符串1'

- 字符串截取，用.Substring()

  > 例："周末去图书馆".Substring(0,2)，计算结果为 '周末'
  > 例："周末去图书馆".Substring(3,3)，计算结果为 '图书馆'

- 字符串替换，用.Replace() 

  > 例："周末去图书馆".Replace("周末","星期天") ，计算结果为 '星期天去图书馆'

- 字符查找，用.IndexOf()

  > 例："周末去图书馆".IndexOf("图")，计算结果为 3

- 字符补齐，右补齐用.PadRight()左补齐用.PadLeft()

  > 例："702".PadLeft(4,'0')，计算结果为：0702
  > 例："702".PadRight(4,'0')，计算结果为：7020

**数字**

- 四舍五入，用Math.Round()

  > 例：Math.Round(12.5862,2) ，计算结果为：12.59

- 取整，用Math.Truncate()

  > 例：Math.Truncate(12.89) ，计算结果为：12

- 取绝对值，用Math.Abs()

  > 例：Math.Abs(-12.89)，计算结果为：12.89

**格式转换**

- 转为数字，用Convert.ToDouble() 

  > 例：Convert.ToDouble('3.14')，计算结果为：3.14

- 转为字符串，用Convert.ToString() 或者.ToString()

  > 例：Convert.ToString(3.14) ，计算结果为：'3.14'

**图元属性**

图元使用 ` DBOBJECT ` 作为关键字，使用该关键字可对图元各种属性进行提取和操作，若有一定 C# 编程功底，可编写代码实现更多自定义功能，下面是一些示例。

- 点坐标

  > `DBOBJECT.Position`

- 文字内容

  > `DBOBJECT.TextString`

- 多段线节点数量

  > `DBOBJECT.EndParam`

- 多段线面积（亩）

  > `Math.Round(DBOBJECT.Area*0.0015,2)`

- 多段线长度（米）

  > `Math.Round( DBOBJECT.Length ,2) `

- 多段线所有节点坐标

  ```c#
  //计算多段线节点坐标
  if (DBOBJECT == null) return "";
  var pl = DBOBJECT as Autodesk.AutoCAD.DatabaseServices.Polyline;
  if (pl == null) return "";
  string fmt = "F3";//坐标小数位，F3是保留3位
  StringBuilder sb = new StringBuilder();
  for (int i = 0; i < pl.NumberOfVertices; i++)
  {
  	var pt = pl.GetPoint3dAt(i);
  	sb.Append(pt.X.ToString(fmt)+ "," + pt.Y.ToString(fmt)+" ");//坐标格式
  }
  return sb.ToString().Trim();
  ```

- 图幅号

  ```c#
  //计算所在图幅号
  if (DBOBJECT == null) return "";
  var ent = DBOBJECT as Entity;
  if (ent == null) return "";
  var point = ent.GeometricExtents.MinPoint;//取实体左下角点
  var str = ((int)Math.Floor(point.X / 250.0) * 0.25).ToString("0.00");
  var str2 = ((int)Math.Floor(point.Y / 250.0) * 0.25).ToString("0.00");
  return str2 + " - " + str;//自由组合图幅号格式
  ```

#### 字段连接<a id="字段连接"></a>

字段连接可将属性表和其他表的数据通过字段进行连接，多用于浏览和更新字段值，若想不打开属性表实现数据更新，可参考 [`挂接外部数据`](#挂接外部数据)；

![](C:\LeoCode\HtCadTool\HelpMd\assets/属性表-连接.png)

**操作步骤：**

1. 选择用于连接的字段和用于连接的表；

   ![image-20230709145913392](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709145913392.png)

2. 验证连接，按提示检查设置；

   ![image-20230709150018387](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709150018387.png)

3. 点击右侧的字段，勾选需要连接到当前数据的字段，确定即可完成连接操作；

   ![image-20230709150317921](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709150317921.png)

**注意事项**

> - 连接加入的字段以灰色背景显示，不可编 辑的，且连接只对当前打开的属性表有效，属性表刷新或关闭后连接销毁；
> - 可通过字段计算的方式将连接获取的数据保存到要素中；
> - 可通过置入字段的方式，直接将连接的字段内容保存到要素中；

#### 属性表其他功能<a id="属性表其他功能"></a>

- 记录联动

  > - 单击行头可选中记录，若打开了属性值 （`EXX`）窗口，则属性值窗口会同步显示所选记录的值；
  > - 双击行头可缩放至行对应实体，若对应的是表，则双击会打开表对应的属性值窗口；
  > - 具体行为可在属性表选项中调整

![image-20230709150800516](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709150800516.png)

- 记录跳转

  > - 打开属性表的前提下，可通过命令 `NN` 快速跳转并缩放至下一条记录
  > - 跳转只针对当前浏览的属性表，属性表关闭后无法快速跳转，面板可以隐藏

- 搜索

  > - 可在搜索框中输入指定值进行搜索定位，Enter可跳转下一条满足条件的记录
  > - 未选中列的情况下进行的是全表搜索，选中列的情况下则只搜索所选列

- 菜单

  > - 行头右键功能菜单，可定位实体，并执行复制等操作；

  ![image-20230709150814269](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709150814269.png)

  > - 列头右键功能菜单，可查看字段属性，并进行关闭、删除，冻结字段等操作；

  ![image-20230709151144333](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709151144333.png)

  > - 选中单元格右键功能菜单，可复制单元格内容等；

  ![image-20230709151151087](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709151151087.png)

- 属性表外观

  > - 功能菜单-选项，弹出口窗口中可调整属性表行高，字体样式等。

![image-20230709150828714](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709150828714.png)

### 属性面板<a id="属性面板"></a>

属性值可在选中实体时即时显示其属性值，用于快速修改，命令 `EXX`

![image-20230709152103765](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152103765.png)

- 一些软件给实体附加了属性，通过属性值界面可以浏览，但字段内容显示为灰色且不可编辑，这是由于这些属性并未在图层字段中“定义”，可通过定义字段来快速添加这些字段，从而实现编辑
- 定义字段打开的就是图层的字段管理器，只是按当前的属性列默认列出了字段，不用一个个去添加而已，实际上要使字段可编辑，在字段管理器中添加同名字段即可

![image-20230709152205604](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152205604.png)

#### 打开外部数据<a id="打开外部数据"></a>

某些字段可能保存的是外部文件的路径或文件名，为了方便浏览，可通过设置链接，使用系统默认应用快速打开对应文件：

1. 单击设置链接打开设置窗口；

![image-20230709152315956](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152315956.png)

2. 勾选启用外部链接，设置文件所在的路径，如有必要，可设置子路径字段，行为可按需求自行设置；

![image-20230709152322962](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152322962.png)

3. 确定后，鼠标移动到字段名称上，会出现小箭头，若设置正确，单击即可用系统默认应用快速打开对应文件；

![image-20230709152328236](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152328236.png)

#### 属性下拉列表<a id="属性下拉列表"></a>

对于一些值内容固定的字段 (我们称之为“字典”或“属性域”），这种字段比较适合通过下拉列表来选择值而非手动输入，下拉列表可通过下列操作来实现：

1. 单击配置属性域

![image-20230709152456592](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152456592.png)

2. 弹出字段属性域界面

![image-20230709152511654](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152511654.png)

3. 首次打开该界面，可能在“属性域”中没有可选项目，则需要通过“编辑域”来添加字典，并添加对应的项目，完成后回到属性域界面选择对应的字典即可

   ![image-20230709152531533](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152531533.png)

> 字典和下拉列表配置保存在文件 DWG 中，复制到其他文件的实体将不共享该定义；
> 属性域和字典都可以保存到本地，复制给其他人使用。

#### 属性连接<a id="属性连接"></a>

`属性连接` 用于批量更新多个图层的多个字段内容，可以理解为 `批量的字段计算器`，除计算字段外，还可以执行一些分类求和等操作，命令 `SXLJ`

![image-20230709152741209](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152741209.png)

**操作步骤**

1. 点击面板上的 `添加` ，在弹出的窗口中配置规则。

   ![image-20230709152752998](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152752998.png)

2. 在 `连接方法` 中选择需要的方法，这儿以 `计算字段` 为例，选择计算字段后，选择 `目标表` 和 `目标字段`。

3. 在 `参数` 中输入计算表达式，确定 即可完成该项规则配置。

   ![image-20230709152811867](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152811867.png)

4. `确定` 后，规则列表中会出现这条规则，可以继续添加多个规则。配置好的规则可 `保存` 到本地，下次使用时 `加载` 即可，也可以将配置文件复制给他人使用。

5. 规则添加完成后，勾选要执行的规则 ，点击 `分析` ，结果列表中会显示计算结果 ，注意此时数据尚未保存。

6. 简单浏览下结果列表的内容，确认无误的话，点击 保存 即可将结果列表中的内容保存到字段中。

   ![image-20230709152901747](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709152901747.png)

**属性连接方法**

| 序号 | 名称     | 说明                                                         |
| ---- | -------- | ------------------------------------------------------------ |
| 1    | 字段追加 | 输入字段的值将以分隔符连接，填入目标字段中。参数为分隔符号   |
| 2    | 求和     | 对输入字段的值进行求和，填入目标字段中 。输入字段只能为数值类型 |
| 3    | 计数     | 统计与目标记录匹配的记录数量，填入目标字段中 。无需指定输入字段 |
| 4    | 分类求和 | 对输入字段的值进行求和，并按分类字段填入目标字段中 。需指定分类字段，输入字段只能为数值类型 |
| 5    | 分类计数 | 统计与目标记录匹配的记录数量，并按分类字段分类填入目标字段中。需指定分类字段，无需指定输入字段 |
| 6    | 计算字段 | 详见 `字段计算器` 关描述                                     |

### 挂接外部数据<a id="挂接外部数据"></a>

纵然属性表和字段计算器已经为 CAD 属性编辑提供了极大便利，但其编辑功能仍不能和 Excel 等专业软件相比，而属性表的字段连接必须打开属性表才能操作，其目的主要是查看而非更新属性，由此设计了 `挂接外部数据`功能，可通过关联字段，将外部数据批量更新到属性表中。

![image-20230710114209882](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710114209882.png)

**操作步骤**

1. 设置 `挂接表、唯一字段、外部表、外部字段`。

   > - 外部表可使用 `支持的格式`中所有格式。
   > - 唯一字段和外部字段类型尽量保持一致，若不一致，软件会在分析时尝试强制转换，转换失败会有提示。
   > - 唯一字段和外部字段若没有一一对应，则取外部数据第一条更新到属性表中。

2. 勾选要更新的字段，设置字段映射。

   > - 设置好图层及字段后，同名字段默认会被勾选。
   > - 勾选外部字段后，若不指定对应的图层字段，会提示向属性表中追加该字段。

   ![image-20230710132834652](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710132834652.png)

3. 点击 `开始连接` ，软件会分析挂接情况，并提示分析结果。

   ![image-20230710132935173](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710132935173.png)

4. 点击 `是` 即可将勾选的字段更新到属性表中。

5. 设置好后可将配置保存，外部数据更新后，通过加载配置快速实现更新。

   > - 配置会保存外部数据路径，若外部数据查找失败，软件会提示选择新的数据源。

### 属性块<a id="属性块"></a>

属性块在图框应用上具有很大便利，但对属性的批量修改却比较困难，可通过属性块相关功能得到解决。

- 属性块转字段，命令 `ATF`

  > - 可将属性块中的内容提取到字段中，方便批量编辑。
  >
  > - 由于不同块中定义的属性字段不同，在提取后用户可按需求定义图层的字段。

- 字段转属性块，命令 `FTA`

  > - 可将字段内容写入到属性块同名字段中，实现属性批量修改。
  >
  > - 属性块结合导出属性表和挂接外部数据功能，可实现通过Excel编辑属性块的效果。



## 空间分析<a id="空间分析"></a>

### 拓扑验证<a id="拓扑验证"></a>

命令`TV`，拓扑验证一般用于修复图形在“微观”层面的一些错误，以规范图形质量，同时也是执行拓扑检查的基础，一些未通过拓扑验证的数据会导致拓扑检查失败，正确理解验证对规范空间数据质量有重要作用。

![image-20230709155704264](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709155704264.png)

> - 验证会对要素折点进行聚类处理，彼此间距离在指定范围内的折点被认为表示同一个位置，换言之，在容差范围内的折点会被捕捉到一起，处于拓扑容差范围内的所有折点在验证过程中均可能轻微移动。
> - 拓扑容差应设置在不影响数据质量的范围内。

**操作步骤**：

1. 在 `图层列表` 中勾选需要加入验证的图层，并设置其 `锁定状态` 和 `优先级` 。
2. 在 `验证设置` 中勾选要验证的项目，在 `容差设置` 中设置合适的容差 。

![image-20230709155927614](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709155927614.png)

3. 点击 `框选验证` 或 `全部验证` ，等待验证完成即可。

   > 拓扑验证会修改数据，使用前注意备份。

**图层列表**

- 图层：在图层列表中勾选图层，其要素将加入拓扑验证 ，注意：锁定、冻结、关闭的图层将不出现在列表中；
- 优先级：优先级高的图层将有更少的要素改动，最高为1，最低10，单击优先级数字可调整；
- 锁定：右键可设置锁定，锁定图层后，该层的要素将尽可能避免更改：
  - 锁定层只执行要素验证，不参与相邻验证；
  - 锁定层比未锁定层有更高的优先级；

**验证设置**

- 要素验证：修复要素自身问题，如重合点、自相交、环走向、尖锐角等，重合点是验证默认项，此外，有以下可选项：

  - 添加自相交点：要素若存在自相交，其交点处将被添加节点；

  - 移除共线节点：若节点到其前后节点所构成线段的距离小于拓扑容差，这三点将被认为是“共线”的，中间节点将被移除；

  - 移除尖角节点：若节点处夹角小于角度容差，该节点将被移除；

  - 调整环走向：闭合要素将调整其环走向为设置值；

    > 注：共线节点和相交节点矛盾时，优先满足相交节点

- 相邻验证：修复和相邻要素间的问题，如相交缺节点、相邻缺节点等：

  - 相交相交节点：若要素与其他要素相交，其交点处将被添加节点
  - 添加相邻节点：若节点到相邻要素节点或边界距离在容差范围内，则该点将被吸附到相邻的节点或边界上
  - 捕捉到锁定层：节点将被捕捉到附近锁定图层的线段上，受距离容差影响，开启锁定图层后生效

**拓扑容差**

拓扑容差用于控制折点位移的范围，可在验证设置-容差设置中设置容差，具体分为3种：

- 距离容差：该范围内所有折点和边界将被视为相同或重合，落在容差范围内的折点和端点将被捕捉到一起；
- 角度容差：折点处夹角小于该值的顶点将被移除；
- 共线容差：点到相邻两点线段的垂直距离小于该值的将视为3点共线，中间节点将被移除。

**注意事项**

- 可参与验证的要素类型有：多段线(`Polyline`)，二维多段线(`Polyline2D`)
- 验证过程会对弧段进行强制转换，转换设置参考 几何转换设置

### 拓扑检查<a id="拓扑检查"></a>

命令`TC`，拓扑检查 一般用于图形的空间关系检查，按指定的规则检查图形数据，列出不满足规则的项供用户快速定位并修改，以完善数据质量，和拓扑验证不同，拓扑检查更“宏观”，检查到的问题一般需要人工核实修改。

![image-20230709160646660](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709160646660.png)

**操作步骤**

1. 点击 添加 ，在弹出界面中按需要设置规则，确定即可将设置好的规则添加至规则列表，可添加多个规则：

   ![image-20230709160717125](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709160717125.png)

   > 配置好的规则可 保存 到本地，下次使用时 加载 即可，也可以将配置文件复制给他人使用。

2. 在规则列表中勾选需要检查的项 ，可多选，执行检查即可：

   ![image-20230709160727410](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709160727410.png)

3. 执行检查后，结果列表会列出检查到的错误，双击节点即可定位至相应的错误项

   ![image-20230709160751687](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709160751687.png)

   > 所有的检查结果均保存在 _TopoCheck_Err 图层中，双击也是定位到该图层中的图形，可按需要删除或者关闭该图层，也可将该图层作为检查结果导出为其他格式，反馈第三方修改；

4. 修改完成后可通过 `清除检查结果` 来清空错误列表；

**拓扑规则<a id="拓扑规则"></a>**

- 单图层规则

  | 序号 | 名称         | 说明                                 |
  | ---- | ------------ | ------------------------------------ |
  | 1    | 不闭合       | 不闭合的多段线将被判定为错误         |
  | 2    | 不能有碎线   | 长度小于容差的多段线将被判定为错误   |
  | 3    | 不能有碎面   | 面积小于容差的多段线将被判定为错误   |
  | 4    | 最小节点间距 | 节点距离小于容差的要素将被判定为错误 |
  | 5    | 最大节点间距 | 节点距离大于容差的要素将被判定为错误 |
  | 6    | 不能有锐角   | 夹角小于容差的要素将被判定为错误     |
  | 7    | 不能有钝角   | 夹角大于容差的要素将被判定为错误     |
  | 8    | 不能重叠     | 重叠要素将被判定为错误               |
  | 9    | 不能有空隙   | 要素间的空隙(空洞)要素将被判定为错误 |

- 复合规则

  | 序号 | 名称                       | 说明                                                  |
  | ---- | -------------------------- | ----------------------------------------------------- |
  | 1    | 要素间距                   | 要素间隔距离大于0且小于容差的要素将被判定为错误       |
  | 2    | 不能与其他要素重叠         | 图层中的要素不能与图层B要素重叠，否则视为错误         |
  | 3    | 不能与其他要素重叠         | 图层中的要素不能与图层B要素重叠，否则视为错误         |
  | 4    | 必须包含                   | 图层中的要素必须包含图层B要素，否则视为错误           |
  | 5    | 不能包含                   | 图层中的要素不能包含图层B要素，否则视为错误           |
  | 6    | 必须被包含                 | 图层中的要素必须被图层B要素包含，否则视为错误         |
  | 7    | 必须包含一个               | 图层中的要素必须包含图层B的一个要素，否则视为错误     |
  | 8    | 必须被一个包含             | 图层中的要素必须被图层B的一个要素包含，否则视为错误   |
  | 9    | 必须与一个相交             | 图层中的要素必须与图层B的一个要素相交，否则视为错误   |
  | 10   | 边界必须被其他要素边界覆盖 | 图层中的要素边界必须被图层B要素边界覆盖，否则视为错误 |

> 为确保图形几何有效，提高拓扑检查结果准确性，可在执行检查前对要检查的图层先执行 拓扑验证 。

### 空间选择<a id="空间选择"></a>

命令：`KJXZ`，利用 空间选择 工具，您可以根据要素相对于另一图层要素的位置来进行选择。 您可使用多种选择方法，选择与同一图层或其他图层中的要素接近或重叠的点、线或面要素。

![image-20230709161308006](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161308006.png)

**操作步骤**

1. 根据需要选取 `选择方法` ，单击下拉箭头查看您的选择。

   ![image-20230709161348559](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161348559.png)

2. 在图层列表中勾选想要选择的 `目标图层` ，可以选择多个。

3. 在 `源图层` 中选择用于选取的图层。

4. 按需要勾选 `使用所选要素` ，勾选后可 `刷新` 。

5. 在 `空间选择方法` 中选取空间关系规则。

   ![image-20230709161355867](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161355867.png)

6. 按需要设置 `搜索距离` ，点击 `应用` 即可完成选择。

### 空间连接<a id="空间连接"></a>

命令：`KJLJ`，空间连接 可利用不同图层中各要素的空间关系为字段赋值，顺带也兼具部分 拓扑检查 的功能。

![image-20230709161508273](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161508273.png)

**操作步骤**

1. 打开 `空间连接` 面板，设置 `输入图层` `输入字段` `目标图层` `目标字段` 。

2. 选择 `空间关系` ，可按需求设置容差，默认为 0.0001 米。

3. 点击 `验证` ，结果列表中会列出匹配情况，单击可定位查看相关图形。

   ![image-20230709161537454](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161537454.png)

4. 检查无误后，点击 `保存` 即可将结果列表中的内容保存到字段中。

5. `搜索` 可对结果列表进行关键字检索，`自动定位` 可在单击节点时定位到图形。

6. 若图层和字段列表中的值和实际不符，可点击 `刷新` 来更新。

**空间连接方法**<a id="空间连接方法"></a>

| 序号 | 名称                 | 说明                                                         |
| ---- | -------------------- | ------------------------------------------------------------ |
| 1    | 输入要素包含目标要素 | 大面对小面、点、文字、块、线等赋值                           |
| 2    | 目标要素包含输入要素 | 点、文字、块、线等给面赋值                                   |
| 3    | 空间距离赋值         | 按要素的空间距离赋值，优先级包含>相交>相邻，容差为查找范围   |
| 4    | 包含求和             | 目标图层包含输入图层，可对输入字段进行求和 （只对数字有效）  |
| 5    | 字段追加             | 目标图层包含输入图层，可对输入字段进行追加 （分隔符只对该项有效） |

**示例**

 将注记内容添加到图形属性 ，在此注记为文字 （在FW注记图层），图形为闭合多段线 （在FW图层）

1. 打开 FW 和 FW注记 图层的属性表，分别添加 Text 字段 ，如已有字段可忽略该步骤。

   ![image-20230709161921591](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161921591.png)

2. 打开 字段计算器 ，计算 Text 字段的值，表达式为 DBOBJECT.TextString，可将文字内容提取到字段中。

   ![image-20230709161926280](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161926280.png)

3. 打开 空间连接 面板，若图层和字段和上述一致，可如下设置，注意空间关系选 目标要素包含输入要素 。

   ![image-20230709161930482](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161930482.png)

4. 设置好后 验证 ，下方列表中会提示验证结果，本例中有8个闭合多段线未包含文字注记，可定位检查修改。

   ![image-20230709161934811](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709161934811.png)

5. 确认后 保存 即可。

### 空间参考<a id="空间参考"></a>

- `AutoCAD` 使用的是以固定坐标定位数据的 2D 和 3D 笛卡尔坐标系。其 x、y 和 z 坐标本质上并不是地理位置，而是相对于任一几何原点 (0,0,0) 的位置。
- 为建立和 GIS 数据的转换，x 轴可以认为是向东的方向，y 轴可以认为是向北的方向，由此建立空间参考。
- 本软件的 `定义投影` 功能需要用户清楚自己所使用数据的坐标系，定义投影只是将该坐标系的参数保存下来，在格式转换和数据交互时提取使用，并不会实际修改图形的坐标值，切记。

**设置全局空间参考**<a id="设置全局空间参考"></a>

设置全局空间参考后，在一些需要坐标系的场景（如导出 `KML` ）会自动使用该坐标系，导出的空间数据也会自动定义为该坐标系。

1. 图层根节点右键，选择 `设置投影` 。

   ![image-20230709162118911](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709162118911.png)

2. 在弹出窗口中选择需要的投影，单击 `确定` 即可 （也可双击投影节点直接确定）。

   ![image-20230709162243910](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709162243910.png)

   > - 搜索框可对坐标系名称进行关键词搜索；
   > - 选择界面列出了常用的地理坐标系和投影坐标系，选中坐标系后会列出参数；
   > - 常用的坐标系可添加至收藏夹，方便下次使用；

3. 有必要的话，可通过 `自定义` 设置坐标系

   ![image-20230709162532765](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709162532765.png)

4. 投影设置成功后会有提示，同时 AutoCAD 状态栏的图形坐标前会显示当前投影名称，未定义投影则显示 `NOPRJ`；

   ![image-20230709162258272](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709162258272.png)

5. 命令 `SPRJ` ，也可以设置投影。

**设置图层空间参考**<a id="设置图层空间参考"></a>

图层空间参考用处和全局空间参考类似，只是具有更高优先级，在导出数据等场景下，若图层和全局都有设置，会优先使用图层空间参考。

设置方法：`图层右键 > 属性 > 设置投影 > 确定`。

![image-20230710174607729](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230710174607729.png)



## 栅格工具<a id="栅格工具"></a>

### 大影像<a id="大影像"></a>

`AutoCAD` 本身可通过 `光栅图像` 或者 `OLE` 加载栅格数据，但这两种方式都有局限性，面对动辄几十上百G的栅格数据显得捉襟见肘，较为主流的方式是将影像裁剪为小图幅瓦片，按需要加载，但这种方式在某些场景下操作较为繁琐，这时候可通过本软件 `大影像` 来实现加载，目前支持的格式如下：<a id="支持的栅格格式"></a>

| 名称        | 后缀       | 读                                                           | 写                                                           | 说明 |
| ----------- | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---- |
| GTIFF       | .tif .tiff | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| HFA         | .img       | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| GPKG        | .gpkg      | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| VRT         | .vrt       | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| JP2OpenJPEG | .jp2 .j2k  | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| PNG         | .png       | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| Rasterlite  | .sqlite    | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| MBTile      | .mbtiles   | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| MFF         | .hdr       | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |
| EHDR        | .bil       | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) | ![img](file://C:/LeoCode/HtCadTool/HelpMd/assets/ok.png?lastModify=1688955285?lastModify=1688975983) |      |

> `大影像` 并非指影像非得要多大，只是系列功能的名称，通过这些功能还可以分割和合并栅格，构建影像金字塔等，结合CAD本身的 `光栅图像` 功能，实现更全面的栅格数据支持。

- 加载影像：命令`GIMG`，也可通过 `影像 > 右键菜单 > 添加影像` 来加载。

![image-20230709173150751](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709173150751.png)

- 移除影像：命令 `CIMG` ，移除所有已加载的影像，也可通过 `影像图层 > 右键菜单 > 移除` 移除单张影像。

![image-20230709172707989](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709172707989.png)

- 导出影像：`影像图层 > 右键菜单 > 导出 > 选择目标格式 > 确定 `，该功能可转换栅格格式，部分CAD光栅图像不支持的格式，可通过转换得到支持的格式。

  ![image-20230709174536546](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709174536546.png)

- 影像裁剪：`影像图层 > 右键菜单 > 裁剪 > 拾取用于裁剪的多边形 > 选择目标格式 > 确定`，该功能可将大影像批量分割为小影像，支持多部件、洞和曲线

  > 该功能可结合 `矩形分幅` 功能使用，命名默认使用图幅号字段，可快速实现影像分割

- 影像合并：命名 `MIMG`，可将具有相同空间参考的影像合并到一起

  ![image-20230709175220264](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709175220264.png)

- 构建金字塔：命令`BOV`，影像有金字塔方能正常加载，该工具用于批量构建影像金字塔。

  ![image-20230709180046899](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709180046899.png)

> - 由于大影像是动态渲染，无法直接打印，若要打印可参考 [`关于打印`](#关于打印)。

### 光栅图像<a id="光栅图像"></a>

AutoCAD 本身的栅格功能不具备识别栅格定位文件的能力，每次加载需要插入到指定位置实现配准，费时费力，`光栅图像` 系列功能由此而来。

- 加载栅格（选文件）：命令 `AIMGF` ，自动识别栅格坐标信息（.tfw；.jpw等），若栅格文件没有坐标信息，则将图像插入到原点。

  > 可一次性选择大量栅格加载，考虑到性能问题，建议不要一次性超过100个

- 加载栅格（选图框）：命令 `AIMG` ，按图框中的路径字段（PATH）加载栅格文件，插入位置和大小由栅格坐标信息确定。

  > 影像的插入位置和大小由栅格文件的坐标信息决定，和图框大小及位置无关，若要将图像缩放至图框大小，请参考 `加载栅格（适应图框）`

- 加载栅格（适应图框）：命令 `AIMB ，按图框位置加载并缩放图像，此处图像由路径字段（PATH）指定，位置和大小由图框决定。

  > 若图框不是正矩形，则取其包络矩形，该方法适合没有坐标信息的图片文件，可通过调整图框实现图片配准，结合 `保存栅格坐标信息` ，可将配准结果保存供其他程序调用。

- 移除栅格：命令`DIMG`，将直接移除所有栅格。

- 构建栅格轮廓：命令 `BIMGB`，可批量生成所选栅格的轮廓，并将栅格路径等信息保存在字段中

  > 当影像数量较多时，全部加载对性能要求较高，这时候可以通过 `加载栅格（选文件）` 加载部分影像，构建其轮廓图框后移除栅格，多次操作后得到完整的影像结合图，图框中保存了栅格路径信息，在需要时选择对应图框加载即可。

- 保存栅格坐标文件：命令 `SIMGW`，可将栅格数据当前的位置信息保存到坐标文件中。

  > 在栅格数据中图像的每个像元都具有一个行号和列号，但并没有实际的坐标信息。要以真实世界坐标显示图像，需要建立一个行列号到坐标的变换以将图像坐标转换为真实世界坐标，栅格坐标文件就是存储这个变换参数。

  | 栅格数据文件 | 坐标文件                             |
  | ------------ | ------------------------------------ |
  | image.tif    | image.tfw 或 image.tifw 或 image.wld |
  | image.jpg    | image.jgw 或 image.jpgw 或 image.wld |
  | image.png    | image.pgw 或 image.wld               |

- 栅格边框可见性：命令 `FV` ，在显示和不显示栅格边框间切换。

- 性能提示

  > - 加载栅格时若栅格在当前视图范围内，则会实时绘制图像，进度条会慢一些，好处是加载完即可正常缩放。若栅格未在视图范围内则加载速度会很快，但加载完成缩放至栅格时仍需要大量时间绘制图像。
  > - 受限于 AutoCAD 的栅格性能，图像过多或者过大都会导致卡顿，默认设置影像质量为低质量，以加快显示速度，若需要高质量可通过内置命令  IMAGEQUALITY 自行设置。

- 关于TIFF<a id="关于TIFF"></a>

  `TIFF（或TIF）`是一种常见的图像文件格式，它可以存储多个图像和元数据，CAD 的光栅图像也支持插入 TIF 图像，但在实际使用过程中会发现一些 TIF 并不能插入 CAD 中，提示如下：

  ![image-20230710105247451](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710105247451.png)

  出现这种情况，除却文件损坏等原因，很有可能是该图像不是传统的 TIF 图像，而是 BigTIFF ，在此简单说明几个概念：

  > TIFF：传统的图像文件格式，TIF格式可以存储32位深度的图像文件，但是文件大小不能超过4GB。**（CAD支持）**
  >
  > BigTIFF ：为打破 TIF 的4GB大小限制而生，使用了64位的地址空间，允许文件大小超过4GB。**（CAD不支持）**
  >
  > GeoTIFF：一种特殊的TIF文件格式，它无需坐标文件 `tfw` ，自身即包含了地理参考信息，，使得GIS软件能够更容易地识别图像的地理位置和坐标系。（CAD不一定支持，具体取决于文件是否是BigTIFF ）

  由于上述格式的后缀名都是 `*.tif 或 *.tiff` ，无法简单通过后缀判别，若出现无法光栅图像无法加载的情况，可通过以下方法解决：

  > 1. 通过 `gimg` 加载图像；
  > 2. 若图像小于4GB，直接导出为TIFF；
  > 3. 若图像大于4GB，通过裁剪将其分割，导出为多个 TIFF；
  > 4. 将导出的结果通过光栅图像加载。

### 在线地图<a id="在线地图"></a>

命令：`STM`，TileMap 是一款用于 AutoCAD 的在线地图浏览和下载工具，可在 AutoCAD 上方便快捷的浏览高德、百度、腾讯、ArcGIS等大部分在线地图，并支持自定义地图，同时提供下载功能。

![image-20230710094501786](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710094501786.png)

#### 基础操作

- 缩放至图层![LayerZoomTo16](C:\LeoCode\HtCadTool\HelpMd\assets/LayerZoomTo16.png)：可缩放至当前图源范围。
- 缩放至分辨率![RasterZoomToResolution16](C:\LeoCode\HtCadTool\HelpMd\assets/RasterZoomToResolution16.png)：在浏览有文字的地图时，缩放至分辨率可将当前层级的地图和当前视图的分辨率对齐，以获得更好的文字显示效果。

![image-20230709182155472](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709182155472.png)

- 鼠标滚动对齐![mouse_select_scroll](C:\LeoCode\HtCadTool\HelpMd\assets/mouse_select_scroll.png)：对齐后，每次滚动滚轮均固定缩放一个层级的地图，浏览体验更好（实际上就是调整 ZOOMFACTOR 参数为100)。

#### 自定义图源<a id="自定义图源"></a>

- 点击图源下方的 `...` 可打开图源管理器，可添加、删除和修改图源；

  ![image-20230710102534607](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710102534607.png)

- 双击可编辑现有图源，点击新增可添加图源；

  ![image-20230710102059885](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710102059885.png)

  > - 图源支持 XYZ 图源，URL中分别用变量 `{x} {y} {z}` 替代 `x y z` 值，量 `{s} {y} {z}` 替代主机编号
  > - 投影类型默认为墨卡托全球，若发现有偏移，可尝试切换为墨卡托中国
  > - 最大级别默认21，若发现缩放到一定级别提示此区域无卫星图，可将此值修改为有图显示的最高级别

#### 浏览选项

选项可以设置地图的透明度、亮度、对比度，可以设置动态投影，将在线地图投影到需要的位置。

![image-20230709182221644](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230709182221644.png)

- 置顶显示：地图默认是居于最底层显示，勾后将置顶显示；

- 显示设置：可设置地图的透明度，亮度，对比度，边框，图号；

- 动态投影：地图默认使用 `WebMercator` 投影，该投影具有最佳的浏览性能，可根据实际需要设置其他投影，使用时注意检查精度，并不是所有坐标系都支持动态投影；

  > 注：动态投影会对显示性能有一定影响

- 等级限制：设置最大缩放级别，超过该级别的地图将不予显示（可用于限制“此区域无卫星图”的显示）；

#### 地图下载<a id="地图下载"></a>

- `选择图源 > 设置投影 > 工具 > 下载影像`

  ![image-20230710095812684](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710095812684.png)

- `绘制/拾取要下载的范围 > 勾选下载级别 > 选择保存位置和格式 > 开始下载`，等待下载完成即可。

  ![image-20230710101355350](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710101355350.png)

- 若要一次下载多个范围，可提前准备好图框（闭合多段线，可通过命令 `GGG` 绘制），通过 `批量下载` 执行选择操作，若所选图框不止一个，选项中会提示设置下载命名字段，设置好字段后，若所选图形有该字段值，则导出的地图会按字段值命名（路径不变）。

  ![image-20230710100359434](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710100359434.png)

- 使用提示

  - 地图下载器不限制速度、下载范围和下载级别，能看就能下，所见即所得；
  - 下载时若定义了动态投影，则下载完成的地图会按此投影定义，未定义则默认投影为 `WebMercator`，下载的影像加载到 `AutoCAD` 可完美套合；
  - 不宜一次执行过大下载范围和过高地图级别的下载，若有大范围下载需求，可自行设置好图框后，利用批量下载来实现；
  - 部分图源在不同地区有不同的等级，下载时请确保所选等级的可用性；
  - 透明度，亮度，边框，编号等选项对下载无效；
  - 使用 `墨卡托中国` 校正的地图，精度会有一定损失；

#### 注意事项

- 地图只适用于模型空间，只有鼠标滚轮拖动和缩放地图可触发地图刷新，若发现屏幕未及时刷新，可略微拖动地图触发刷新；

- 低版本CAD可能会提示已无法进一步缩放，此时用命令 `REGEN` 刷新即可；

- 地图经过投影转换，使用前请检查其精度；

- 部分图源在切换时比较慢，请耐心等待，切换后若有部分瓦片没刷新的情况，可手动清理缓存；

- 若拖动地图时感觉卡顿，可尝试在CAD选项中开启硬件加速：`Option > 系统 > 图形性能 > 开启硬件加速`。

  ![image-20230710134520256](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710134520256.png)

### 关于栅格工具

大影像、光栅图像和在线地图适用场景各有不同，具体如下

| 类型     | 特点及适用场景                                               | 打印支持 |
| -------- | ------------------------------------------------------------ | -------- |
| 光栅图像 | 是对CAD光栅功能的扩展，需要CAD支持的格式，适合加载较多的小影像，且需要打印的场景 | 是       |
| 大影像   | 动态绘制，不受CAD格式限制，且可加载较大尺寸的影像，适用于CAD无法加载的场景 | 否       |
| 在线地图 | 动态绘制，即时浏览、套图、下载等场景                         | 否       |

### 关于打印<a id="关于打印"></a>

大影像，在线地图以及字段标注是动态绘制的，不支持打印，想要打印可参考下面的方法：

- 大影像：通过光栅图像加载即可打印。

- - 影像格式不受支持的，可先导出为支持的格式
  - 影像太大光栅图像无法加载的，可通过裁剪工具裁剪后再加载

- 在线地图：直接下载，之后处理方式同大影像
- 字段标注：标注转为注记即可

注意：在线地图下载并非级别越高越好，注意根据应用场景判别。实际情况是国内几乎没有超过18级的在线地图，即使显示提示是20级，也只是18或更低级别的影像重采样到20级的，实际分辨率并没有提升，没必要去追求高级别，这点注意甄别



## 编辑工具<a id="编辑工具"></a>

### 多部件工具<a id="多部件工具"></a>

GIS 要素类型中的多部件面在 `AutoCAD` 中没有直接的对应图元，由此设计了多部件块，用于保存多部件要素信息，多部件块本身是 CAD 的块，只是在扩展属性中加入标签以便软件识别。

- 合并多部件（构建多部件）,命令： `BB`

  > - 输入命令并选择用于构面的闭合多段线后，软件会分析洞和多部件信息，编辑器会显示分析结果，并提示构建
  > - 拆分后的多个多部件块，可以用自动合并多部件命令 `BBA` 批量合并，并维持原有结构。

  ![image-20230710141132135](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710141132135.png)

- 拆分多部件，命令： `XX`

  > - 只有通过 `XX` 拆分的多部件，才可以通过 `自动合并多部件` 自动复原。
  > - 炸开命令 X 也可以拆分多部件，但会失去构造部件的标签，无法使用 `自动合并多部件`。

- 编辑多部件块，命令： `BBE`

  > - 也可以双击多部件块来原位编辑，添加或删除部件，通过命令 `BC` 保存编辑内容。

- 清理多部件块，命令： `BCC`

  > - 构建块时会自动生成块，该命令可以清除未使用的块引用，也可以通过清理命令 `PURGE` 直接清理。

### 多段线工具<a id="多段线工具"></a>

- 简化线，命令：`JHX` <PolylineSimplify>
- 删除节点，命令：`EE` <RemoveVertex>
- 删除节点-框选，命令：`EEK` <RemoveVertexByRectangle>
- 添加节点，命令：`AA` <AddVertex>
- 显示起点，命令：`XSQD` <ShowStartVertex>
- 调整起点，命令：`SS` <ResetStartVertex>
- 调整起点到西北方，命令：`SXBD` <SetStartVertexWN>
- 整形，命令：`RR` <PolylineReshape>
- 直线校正，命令：`SL` <SnapToLine>
- 转为多段线，命令：`SXBD` <SetStartVertexWN>
- 替换几何，命令：`THJH` <ReplacePolyline>
- 弧段简化，命令：`ASS` <ARCSAMPLE>

### 面处理<a id="面处理"></a>

- 分割面，命令：`CC` <SplitPolygon>
- 分割面 -按面积，命令：`CCA` <SplitPolygonByArea>
- 合并面，命令：`MM` <MergePolygon>
- 构面-设置，命令：`GS` <BuildPolygonSetting>
- 构面-自动完成面，命令：`GF` <AutoFinishPolygon>
- 构面-边界构面，命令：`GG` <BuildPolygonByLine>
- 构面-拾取点构面，命令：`GB` <BuildPolygonByPickPoint>

### 文字处理<a id="文字处理"></a>

- 文字遮罩，命令 `WZZZ`，可批量生成文字遮罩。

  ![image-20230710182839954](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230710182839954.png)

- 文字居中

- 字段转文字



## 标注注记<a id="标注注记"></a>

- 注记 （`Annotation`）：在 `AutoCAD` 中，注记一般以 文字 （`DBText`）的形式存在，将文字放在特定位置，起到说明的效果。
- 标注 （`Label`）：主要用于将要素的属性显示出来，该属性可以是字段内容、多段线长度、面积、点坐标等。和注记不同，标注是动态的、基于属性的，属性改变则内容也会改变，无需用户手动去维护其一致性，标注和图元是一体的，图元移动或删除，标注也就随之移动或删除。下面列出了标注和注记的一些区别：

### 字段标注<a id="字段标注"></a>

**操作步骤**

1. 图层右键菜单，选择 `标注要素`；

   ![image-20230710144258983](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710144258983.png)

2. 在弹出窗口中设置名称和字段表达式；

   ![image-20230710144308932](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710144308932.png)

3. 字段表达式可选择单个字段，可设置组合字段，也可通过 `DBOBJECT` 关键字设置图元属性，语法可参见 `字段计算器`；

   ![image-20230710144314401](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710144314401.png)

4. `确定` 即可完成标注，设置好的标注下次可直接使用，无需再次设置；

5. 标注好的图层，可通过 `将标注转为注记`，实现标注到注记的转换；

   ![image-20230710144338122](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710144338122.png)

6. 若要调整标注细节 ，如字高、颜色、文字样式等，或为一个图层设置多个标注，可通过 `标注管理器` 实现。

**标注管理器**<a id="标注管理器"></a>

- 设置好的标注，可通过标注管理器查看并管理，命令：`LM` <LABELMANAGER>

  ![image-20230710144506758](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710144506758.png)

- 左边的列表会列出所有标注，可自由添加或删除

- 选中标注，右边会列出该标注的详细属性，如字段表达式、标注位置、偏移量、文字样式、颜色等，修改后应用即可

- 通过为一个图层添加多个标注，并设置其偏移量、边框、对齐方式等方法，可实现分数标注、多行、多列等组合效果

**标注性能**

- 修改标注或通过 `STYLE` 命令修改字体后，标注内容可能未及时更新，此时通过 `REGEN` 命令重新生成即可；
- 标注是动态计算的，数据量特别大的话，`REGEN` 命令重生成可能有一定卡顿，可根据数据量酌情使用；
- 从效率出发，标注建议使用 `SHX` 字体，在出图或有必要时再切换为 `TrueType` 字体（如宋体）；

### 长度注记<a id="长度注记"></a>

### 长度注记（临时）<a id="长度注记（临时）"></a>

### 字段注记<a id="字段注记"></a>



## 通用工具<a id="通用工具"></a>

### 裁剪工具<a id="裁剪工具"></a>

- 保留指定区域，命令 `CEK`

  > 裁剪并删除所选范围外所有要素，只保留范围内要素。

- 删除指定区域，命令 `CED`

  > 裁剪并删除所选范围内所有要素。

- 指定区域存盘，命令 `CES`

  > 按所选范围裁剪要素，并将其另存为单个文件。

### 打印输出<a id="打印输出"></a>

打印输出主要包含打印PDF和高清截图两种，二者各有适用场景：

#### 打印为PDF<a id="打印为PDF"></a>

打印PDF是对系统打印机的扩展，既可拾取范围快速打印，也可批量多图框多文件打印，支持自定义和自适应纸张。

- 按范围打印，命令 `BPP`

  > 

- 按图框打印，命令 `BPT`

  > 

- 按文件打印，命令 `BPF`

  > 

#### 高清截图<a id="高清截图"></a>

命令 `GQJT`，高清截图是对打印功能的补充，可将目标区域输出为高清图片，支持批量截取，好处是方便快捷，所见即所得。

![image-20230711112024776](C:\LeoCode\HtCadTool\HelpMd\assets\image-20230711112024776.png)

- 分辨率以像素为单位，有三种模式：

  > 锁定宽度：输出的图片宽度将被固定，高度则按目标范围等比例缩放。
  >
  > 锁定高度：同上，输出的图片高度将被固定，宽度比例缩放。
  >
  > 指定倍率：宽度和高度均按目标范围屏幕分辨率倍率缩放。

- 批量模式，也就是按图框批量截图

  > 该模式需要指定图框所在图层、命名字段以及保存位置，输出图片将按字段值命名。
  >
  > 批量截图时可通过 `ESC` 取消

- 边界缓冲（%）

  > 实际输出的范围将按该参数向外/内调整，单位是目标范围长宽的百分比，

- 白色透明：输出图片的白色部分将自动透明处理。

- 保存PDF：将输出的图片转为PDF。

- 截取到剪切板：将截图到剪切板而非文件，方便直接粘贴使用（该设置对批量模式无效）。

- 指定底色：设置截图的背景色。

- 截图方式共有三种：

  - 截原色图：该模式将直接截取和CAD窗口所见效果一致的图片。
  - 截指定底色：按照设置的底色来改变背景色并截图。
  - 截灰度图：按照设置的底色来改变背景色，并截取灰度图。

- 注意事项

  > - 理论上支持最大5亿像素截图，实际使用受限于CAD版本、设备内存等，过高的像素可能会导致内存溢出，且截取效率较低，请酌情使用。
  > - 若实在需要获取超大的图片，可使用打印工具打印为PDF后，再转换为图片，矢量格式的PDF转为图片同样高清。
  > - 高清截图仅支持模型空间

### 合并拆分<a id="合并拆分"></a>

- 批量插入DWG，命令 `DWGIN`

  > 

- 批量导出DWG，命令 `DWGOUT`

  > 

- 按图层导出DWG，命令 `DWGL`

  > 

- 按范围导出DWG，命令 `DWGF`

  > 

- 按字段拆分图层，命令 `DWGLF`

  > 

- 矩形分幅，命令 `GGG`

  > 

## 导航工具<a id="导航工具"></a>

图层

菜单

工具箱



## 关于

**授权<a id="授权"></a>**

命令：`LIC`

![image-20230710143638594](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710143638594.png)

**关于<a id="关于"></a>**

命令：`SINFO`，显示当前的版本信息，若有新版本也会提示更新。

![image-20230710143602284](C:\LeoCode\HtCadTool\HelpMd\assets/image-20230710143602284.png)

